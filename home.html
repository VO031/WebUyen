<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home - Qu·∫£n l√Ω cu·ªôc h·ªçp</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 25px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      background: white; border-radius: 16px; padding: 24px 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25); margin-bottom: 25px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 20px;
    }
    .user-info { display: flex; align-items: center; gap: 16px; }
    .avatar { width: 56px; height: 56px; border-radius: 50%; border: 3px solid #667eea; object-fit: cover; }
    .avatar-fallback {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 20px; font-weight: bold; border: 3px solid #fff;
    }
    .user-details h1 { font-size: 20px; color: #1a1a1a; margin-bottom: 4px; }
    .user-details p { color: #666; font-size: 13px; }
    .badge { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-admin { background: #ff9800; color: white; border: none; padding: 12px 22px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; text-decoration: none; }
    .btn-admin:hover { background: #f57c00; transform: translateY(-2px); }
    .logout-btn { background: #d32f2f; color: white; border: none; padding: 12px 22px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; }
    .logout-btn:hover { background: #b71c1c; transform: translateY(-2px); }
    .content { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-bottom: 20px; }
    .content h2 { color: #1a1a1a; margin-bottom: 24px; font-size: 24px; display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
    .form-group label .required { color: #d32f2f; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
      font-size: 15px; font-family: inherit; transition: all 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .btn-primary {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 14px 32px;
      border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700;
      transition: all 0.3s; width: 100%; margin-top: 15px;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
    }
    .btn-primary:hover { background: linear-gradient(90deg, #5568d3 0%, #663991 100%); transform: translateY(-2px); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .error-page { text-align: center; padding: 60px 20px; }
    .error-page h1 { font-size: 48px; color: #d32f2f; margin-bottom: 16px; }
    .participant-tag {
      display: inline-flex; align-items: center; gap: 6px;
      background: #e3f2fd;
      color: #1e88e5;
      padding: 6px 12px; border-radius: 20px;
      margin: 4px; font-size: 13px; font-weight: 600;
      border: 1px solid #bbdefb;
    }
    .participant-tag button { background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px; padding: 0; margin-left: 4px; }
    .participants-list {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
      min-height: 40px; padding: 10px; border: 2px dashed #bbdefb; border-radius: 8px;
    }
    .empty-state { color: #999; font-size: 13px; font-style: italic; }
    .add-participant-btn { 
        background: #4caf50; color: white; border: none; padding: 10px 18px; 
        border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; 
        margin-top: 8px; transition: background 0.3s;
    }
    .add-participant-btn:hover { background: #388e3c; }
    .success-message, .error-message { padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none; border-left: 5px solid; font-weight: 600; }
    .success-message { background: #e8f5e9; color: #2e7d32; border-left-color: #4caf50; }
    .error-message { background: #ffebee; color: #d32f2f; border-left-color: #d32f2f; }
    .success-message.show, .error-message.show { display: block; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
    .tab-btn { background: none; border: none; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; color: #999; border-bottom: 3px solid transparent; transition: all 0.3s; }
    .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .meetings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .meeting-card { 
      background: #ffffff;
      border: 1px solid #e0e0e0; 
      border-radius: 12px; 
      padding: 20px; 
      transition: all 0.3s; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .meeting-card:hover { border-color: #667eea; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2); transform: translateY(-3px); }
    .meeting-card h3 { color: #1a1a1a; margin-bottom: 12px; font-size: 18px; font-weight: 700; }
    .meeting-card p { color: #666; font-size: 14px; margin-bottom: 8px; }
    .meeting-card .time { color: #667eea; font-weight: 700; }
    .meeting-card a { color: #667eea; text-decoration: underline; word-break: break-all; }
    
    .document-link-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .document-link-group input { flex: 1; margin-bottom: 0; }
    .remove-doc-btn {
        background: #e57373;
        color: white;
        border: none;
        padding: 12px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.3s;
    }
    .remove-doc-btn:hover { background: #d32f2f; }
    .add-doc-btn {
        background: #00bcd4;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.3s;
        display: inline-block;
        margin-top: 5px;
    }
    .add-doc-btn:hover { background: #0097a7; }
    #documentModal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; }
    #documentModal > div {
        background-color: #fefefe; 
        margin: 10% auto; 
        padding: 30px; 
        border: 1px solid #ddd; 
        width: 90%; 
        max-width: 650px; 
        border-radius: 15px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        position: relative;
    }
    .close-btn { color: #aaa; float: right; font-size: 30px; font-weight: bold; cursor: pointer; }
    .close-btn:hover { color: #777; }
    
    /* CALENDAR STYLES */
    .calendar-controls .nav-btn {
        background: #667eea; color: white; border: none; padding: 8px 15px; 
        border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; 
        transition: background 0.3s;
    }
    .calendar-controls .nav-btn:hover { background: #5568d3; }
    .days-of-week {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: 700;
        color: #764ba2;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 10px;
    }
    .days-of-week > div { padding: 5px 0; }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-gap: 5px;
    }
    .calendar-day {
        min-height: 80px;
        background: white;
        border-radius: 8px;
        padding: 8px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #f0f0f0;
        transition: all 0.2s;
        position: relative;
    }
    .calendar-day:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    .calendar-day.inactive-month {
        background: #f8f9fa;
        color: #ccc;
        cursor: default;
    }
    .calendar-day.inactive-month:hover {
        border-color: #f0f0f0;
        box-shadow: none;
    }
    .calendar-day .day-number {
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
        text-align: right;
        font-size: 16px;
    }
    .calendar-day.has-meeting {
        border-color: #4caf50;
        background: #e8f5e9;
    }
    .calendar-day.has-meeting .meeting-indicator {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: #2e7d32;
        border-radius: 50%;
    }
    .calendar-day.current-day {
        border: 2px solid #d32f2f;
        background: #ffebee;
        box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
    }
    .meeting-summary-item {
        margin-bottom: 10px;
        padding: 10px;
        border-left: 5px solid #667eea;
        background: #f5f7ff;
        border-radius: 6px;
    }
    .meeting-summary-item h4 {
        margin: 0 0 5px 0;
        color: #1a1a1a;
        font-size: 15px;
    }
    .meeting-summary-item p {
        margin: 0;
        font-size: 14px;
        color: #444;
    }
    #noMeetingsFound { color: #999; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <div id="authContent"></div>
  </div>

  <div id="documentModal">
      <div>
          <span onclick="closeDocumentModal()" class="close-btn">&times;</span>
          <h2 style="font-size: 20px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px;">üìÑ C·∫≠p nh·∫≠t T√†i li·ªáu Cu·ªôc h·ªçp</h2>
          <p id="modalMeetingTitle" style="color: #667eea; margin-bottom: 15px; font-weight: 600;"></p>
          
          <div id="modalContent">
              <div class="form-group">
                  <label>C√°c Link T√†i li·ªáu</label>
                  <div id="documentLinksContainerModal"></div>
                  <p style="font-size: 12px; color: #d32f2f; margin-top: -5px; margin-bottom: 10px; font-weight: 600;">
                      ‚ö†Ô∏è C√°c link t√†i li·ªáu g·ªëc kh√¥ng ƒë∆∞·ª£c ph√©p ƒë·ªÉ tr·ªëng!
                  </p>
                  <button type="button" class="add-doc-btn" onclick="addModalDocumentLinkInput(document.getElementById('documentLinksContainerModal'), '')">‚ûï Th√™m link T√†i li·ªáu m·ªõi</button>
              </div>
              <button class="btn-primary" id="saveDocBtn" onclick="saveDocuments()">üíæ L∆∞u t√†i li·ªáu</button>
              <div id="modalMessage" class="error-message" style="margin-top: 15px;"></div>
          </div>

          <div id="modalView" style="display: none;">
              <div style="max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px;">
                 <p id="viewLinksContainer"></p>
              </div>
              <button class="btn-primary" onclick="closeDocumentModal()" style="background: #999; width: auto; display: inline-block; margin-top: 20px;">ƒê√≥ng</button>
          </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCsbZeCIr7mMabfVIlNBWQuoAFBQYxEIu4",
      authDomain: "iot1-8812b.firebaseapp.com",
      databaseURL: "https://iot1-8812b-default-rtdb.firebaseio.com",
      projectId: "iot1-8812b",
      storageBucket: "iot1-8812b.firebasestorage.app",
      messagingSenderId: "325115994620",
      appId: "1:325115994620:web:c8d99d4d4b4646228d1279"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseSet = set;
    window.firebaseOnValue = onValue;
    window.firebaseUpdate = update;
  </script>

  <script>
    // Danh s√°ch c√°c ph√≤ng h·ªçp c·ªë ƒë·ªãnh
    const MEETING_ROOMS = [
      'A11',
      'A12',
      'A13',
      'A14',
      'A15',
      'A16',
      'A17'
    ];
    
    let allSystemEmails = []; 
    
    // NEW FUNCTION to fetch system emails from Firebase
    async function fetchSystemEmails() {
      const emailsRef = window.firebaseRef(window.firebaseDB, 'allowed_emails');
      return new Promise((resolve) => {
        window.firebaseOnValue(emailsRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            allSystemEmails = Object.values(data);
          } else {
            allSystemEmails = [];
          }
          resolve();
        }, { onlyOnce: true });
      });
    }

    // CALENDAR VARIABLES
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    const DAYS_OF_WEEK = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
    let allMeetings = {}; // Store all fetched meetings by date 'YYYY-MM-DD'
    let rawAllMeetings = {}; // Store all fetched meetings by ID

    let selectedParticipants = [];
    let currentMeetingId = null;

    async function checkAuth() { 
      const email = sessionStorage.getItem('email');
      const name = sessionStorage.getItem('name');
      const picture = sessionStorage.getItem('picture');
      const idToken = sessionStorage.getItem('id_token');
      const is_admin = sessionStorage.getItem('is_admin') === 'true';

      if (!email || !idToken) {
        showErrorPage();
        return;
      }
      
      // Ch·ªù cho danh s√°ch email ƒë∆∞·ª£c t·∫£i tr∆∞·ªõc khi hi·ªÉn th·ªã dashboard
      await fetchSystemEmails(); 

      showDashboard({ email, name, picture, is_admin });
    }

    function showErrorPage() {
      document.getElementById('authContent').innerHTML = `
        <div class="content error-page">
          <h1>üîí Ch∆∞a ƒëƒÉng nh·∫≠p</h1>
          <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y</p>
          <a href="index.html" class="btn-primary" style="width:auto; display:inline-block; text-decoration:none;">ƒêƒÉng nh·∫≠p ngay</a>
        </div>
      `;
    }

    function showDashboard(userData) {
      const { email, name, picture, is_admin } = userData;
      const initial = name ? name.charAt(0).toUpperCase() : email.charAt(0).toUpperCase();
      const emailOptions = allSystemEmails.map(e => `<option value="${e}">${e}</option>`).join('');
      
      // T·∫°o c√°c th·∫ª <option> cho ph√≤ng h·ªçp
      const roomOptions = MEETING_ROOMS.map(room => `<option value="${room}">${room}</option>`).join('');

      document.getElementById('authContent').innerHTML = `
        <div class="header">
          <div class="user-info">
            ${picture ? `<img src="${picture}" alt="Avatar" class="avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="avatar-fallback" style="display:none;">${initial}</div>` : `<div class="avatar-fallback">${initial}</div>`}
            <div class="user-details">
              <h1>üëã ${name || 'User'}</h1>
              <p>${email}</p>
              <span class="badge">‚úì ƒê√£ x√°c th·ª±c</span>
            </div>
          </div>
          <div class="header-buttons">
            ${is_admin ? `<a href="admin.html" class="btn-admin">‚öôÔ∏è Qu·∫£n l√Ω Email</a>` : ''}
            <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
          </div>
        </div>

        <div class="content">
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('create')">üìù T·∫°o cu·ªôc h·ªçp</button>
            <button class="tab-btn" onclick="switchTab('calendar')">üóìÔ∏è L·ªãch c·ªßa t√¥i</button>
            <button class="tab-btn" onclick="switchTab('list')">üìã Danh s√°ch cu·ªôc h·ªçp</button>
          </div>

          <div id="create" class="tab-content active">
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message">‚úÖ T·∫°o cu·ªôc h·ªçp th√†nh c√¥ng!</div>
            <h2>üìÖ T·∫°o cu·ªôc h·ªçp m·ªõi</h2>
            
            <form id="meetingForm" onsubmit="handleSubmit(event)">
              <div class="form-group">
                <label>T√™n cu·ªôc h·ªçp <span class="required">*</span></label>
                <input type="text" id="meetingName" placeholder="V√≠ d·ª•: H·ªçp tu·∫ßn Sprint Planning" required>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Th·ªùi gian b·∫Øt ƒë·∫ßu <span class="required">*</span></label>
                  <input type="datetime-local" id="startTime" required>
                </div>
                <div class="form-group">
                  <label>Th·ªùi gian k·∫øt th√∫c <span class="required">*</span></label>
                  <input type="datetime-local" id="endTime" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Ch·ªß t·ªça <span class="required">*</span></label>
                  <select id="chairperson" required>
                    <option value="">-- Ch·ªçn ch·ªß t·ªça --</option>
                    ${emailOptions}
                  </select>
                </div>
                <div class="form-group">
                  <label>Th∆∞ k√Ω <span class="required">*</span></label>
                  <select id="secretary" required>
                    <option value="">-- Ch·ªçn th∆∞ k√Ω --</option>
                    ${emailOptions}
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Th√†nh vi√™n tham gia kh√°c</label>
                <select id="participantSelect">
                  <option value="">-- Ch·ªçn th√†nh vi√™n --</option>
                  ${emailOptions}
                </select>
                <button type="button" class="add-participant-btn" onclick="addParticipant()">‚ûï Th√™m th√†nh vi√™n</button>
                <div class="participants-list" id="participantsList">
                  <span class="empty-state">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c th√™m</span>
                </div>
                <p style="font-size: 12px; color: #999; margin-top: 8px;">üí° Ch·ªß t·ªça, th∆∞ k√Ω v√† b·∫°n ƒë√£ t·ª± ƒë·ªông tham gia cu·ªôc h·ªçp</p>
              </div>
              
              <div class="form-group">
                <label>ƒê·ªãa ƒëi·ªÉm h·ªçp <span class="required">*</span></label>
                <select id="location" required>
                  <option value="">-- Ch·ªçn ph√≤ng h·ªçp --</option>
                  ${roomOptions}
                </select>
                <p style="font-size: 12px; color: #999; margin-top: 8px;">üí° N·∫øu l√† h·ªçp tr·ª±c tuy·∫øn, h√£y ghi r√µ link trong ph·∫ßn T√†i li·ªáu ƒë√≠nh k√®m ho·∫∑c t√™n cu·ªôc h·ªçp.</p>
              </div>
              
              <div class="form-group">
                <label>Link T√†i li·ªáu</label>
                <div id="documentLinksContainer"></div>
                <button type="button" class="add-doc-btn" onclick="addDocumentLinkInput()">‚ûï Th√™m link T√†i li·ªáu</button>
              </div>

              <button type="submit" class="btn-primary" id="submitBtn">‚ú® T·∫°o cu·ªôc h·ªçp</button>
            </form>
          </div>

          <div id="calendar" class="tab-content">
            <h2>üóìÔ∏è L·ªãch cu·ªôc h·ªçp c·ªßa t√¥i</h2>
            
            <div class="calendar-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <button class="nav-btn" onclick="changeMonth(-1)">&#9664; Th√°ng tr∆∞·ªõc</button>
                <h3 id="currentMonthYear" style="color: #667eea; font-weight: 700; margin: 0;"></h3>
                <button class="nav-btn" onclick="changeMonth(1)">Th√°ng sau &#9654;</button>
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
              <label>L·ªçc theo Ph√≤ng</label>
              <select id="calendarFilterRoom" onchange="loadCalendarMeetings()">
                <option value="">-- T·∫•t c·∫£ ph√≤ng --</option>
                </select>
            </div>
            <div class="calendar-grid-container" style="background: #f8f9fa; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <div id="calendarDaysOfWeek" class="days-of-week"></div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>

            <div id="dailyMeetingsList" style="margin-top: 25px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0;">
                <h3 style="color: #1a1a1a; margin-bottom: 15px;">Chi ti·∫øt cu·ªôc h·ªçp trong ng√†y <span id="selectedDateTitle" style="color: #667eea;"></span></h3>
                <p id="meetingsForDayContent" style="color: #666;">Ch·ªçn m·ªôt ng√†y tr√™n l·ªãch ƒë·ªÉ xem chi ti·∫øt.</p>
            </div>
          </div>

          <div id="list" class="tab-content">
            <h2>üìã Danh s√°ch cu·ªôc h·ªçp</h2>
            <div class="filter-controls" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                  <label>L·ªçc theo Ng√†y</label>
                  <input type="date" id="filterDate" onchange="loadMeetings()">
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                  <label>L·ªçc theo Ph√≤ng</label>
                  <select id="filterRoom" onchange="loadMeetings()">
                    <option value="">-- T·∫•t c·∫£ ph√≤ng --</option>
                    </select>
                </div>
            </div>
            <p style="font-style: italic; color: #666; margin-bottom: 15px;">Hi·ªÉn th·ªã t·∫•t c·∫£ cu·ªôc h·ªçp (ƒë√£ qua v√† s·∫Øp t·ªõi) li√™n quan ƒë·∫øn b·∫°n theo ƒëi·ªÅu ki·ªán l·ªçc.</p>
            <div id="meetingsContainer" class="meetings-grid">
              <p style="text-align: center; padding: 20px; grid-column: 1/-1;">ƒêang t·∫£i...</p>
            </div>
          </div>
        </div>
      `;

      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('startTime').value = now.toISOString().slice(0, 16);

      const endTime = new Date(now.getTime() + 60 * 60 * 1000);
      document.getElementById('endTime').value = endTime.toISOString().slice(0, 16);

      document.getElementById('chairperson').addEventListener('change', updateParticipantDropdown);
      document.getElementById('secretary').addEventListener('change', updateParticipantDropdown);

      addDocumentLinkInput();
      
      // Load all meetings into memory once when the dashboard is shown
      loadAllMeetingsToMemory(); 
    }
    
    // NEW FUNCTION: Load all meetings into memory
    function loadAllMeetingsToMemory() {
        const meetingsRef = window.firebaseRef(window.firebaseDB, 'meetings');
        window.firebaseOnValue(meetingsRef, (snapshot) => {
            rawAllMeetings = snapshot.val() || {};
            // If the user is on a tab that needs data, refresh it
            if (document.getElementById('list').classList.contains('active')) {
                loadMeetings();
            }
            if (document.getElementById('calendar').classList.contains('active')) {
                loadCalendarMeetings();
            }
        });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // Since rawAllMeetings is updated via onValue, loadMeetings/loadCalendarMeetings 
      // can just process the data immediately.
      if (tabName === 'list') loadMeetings();
      if (tabName === 'calendar') loadCalendarMeetings(); 
    }

    function addDocumentLinkInput(initialLink = '') {
      const container = document.getElementById('documentLinksContainer');
      const newGroup = document.createElement('div');
      newGroup.className = 'document-link-group';

      const newInput = document.createElement('input');
      newInput.type = 'url';
      newInput.placeholder = 'Nh·∫≠p link t√†i li·ªáu (V√≠ d·ª•: https://docs.google.com/...)';
      newInput.className = 'document-link-input'; 
      newInput.value = initialLink;

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'remove-doc-btn';
      removeButton.textContent = 'X√≥a';
      removeButton.onclick = () => {
        container.removeChild(newGroup);
      };
      
      newGroup.appendChild(newInput);
      newGroup.appendChild(removeButton);
      container.appendChild(newGroup);
    }
    
    function addModalDocumentLinkInput(container, initialLink = '', isOriginal = false) { 
        const newGroup = document.createElement('div');
        newGroup.className = 'document-link-group';

        const newInput = document.createElement('input');
        newInput.type = 'url';
        newInput.placeholder = isOriginal ? 'Link g·ªëc (Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng)' : 'Nh·∫≠p link t√†i li·ªáu...';
        newInput.className = 'modal-document-link-input'; 
        
        if (isOriginal) {
            newInput.classList.add('original-link-input'); 
        }
        
        newInput.value = initialLink;
        newGroup.appendChild(newInput);
        
        if (!isOriginal) {
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-doc-btn';
            removeButton.textContent = 'X√≥a';
            removeButton.onclick = () => {
                container.removeChild(newGroup);
            };
            newGroup.appendChild(removeButton);
        }
        
        container.appendChild(newGroup);
    }

    function showEditDocumentModal(meetingId, title, documentLinks, canEdit) {
        currentMeetingId = meetingId;
        const modal = document.getElementById('documentModal');
        const modalTitle = document.getElementById('modalMeetingTitle');
        const modalContent = document.getElementById('modalContent');
        const modalView = document.getElementById('modalView');
        const linksContainerModal = document.getElementById('documentLinksContainerModal');
        const modalH2 = document.querySelector('#documentModal h2');

        modalTitle.textContent = `Cu·ªôc h·ªçp: ${title}`;

        if (canEdit) {
            modalContent.style.display = 'block';
            modalView.style.display = 'none';
            modalH2.textContent = '‚úèÔ∏è C·∫≠p nh·∫≠t T√†i li·ªáu Cu·ªôc h·ªçp';
            
            linksContainerModal.innerHTML = '';
            
            if (documentLinks.length > 0) {
                 documentLinks.forEach((link) => {
                     addModalDocumentLinkInput(linksContainerModal, link, true); 
                 });
            }
            addModalDocumentLinkInput(linksContainerModal, '', false); 

        } else {
            modalContent.style.display = 'none';
            modalView.style.display = 'block';
            modalH2.textContent = 'üëÅÔ∏è Xem T√†i li·ªáu Cu·ªôc h·ªçp';
            
            const viewLinksContainer = document.getElementById('viewLinksContainer');
            const linksHtml = documentLinks.length > 0 
                ? documentLinks.map(link => 
                    `<p style="font-size: 14px; margin: 8px 0;">
                        <a href="${link}" target="_blank" style="color: #667eea; text-decoration: underline; word-break: break-all;">${link}</a>
                    </p>`).join('')
                : '<p style="color: #999;">Ch∆∞a c√≥ t√†i li·ªáu ƒë√≠nh k√®m.</p>';
            viewLinksContainer.innerHTML = linksHtml;
        }
        
        modal.style.display = 'block';
    }

    function viewDocuments(meetingId, title, documentLinks) {
        showEditDocumentModal(meetingId, title, documentLinks, false); 
    }
    window.viewDocuments = viewDocuments; 

    function closeDocumentModal() {
        document.getElementById('documentModal').style.display = 'none';
    }
    window.closeDocumentModal = closeDocumentModal; 

    async function saveDocuments() {
        const meetingId = currentMeetingId;
        const saveBtn = document.getElementById('saveDocBtn');
        const modalMessage = document.getElementById('modalMessage');

        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';

        try {
            if (!meetingId) throw new Error('Kh√¥ng t√¨m th·∫•y ID cu·ªôc h·ªçp.');
            
            const linksInputs = document.querySelectorAll('.modal-document-link-input');
            
            // Validate original links (the ones rendered initially)
            linksInputs.forEach(input => {
                if (input.classList.contains('original-link-input') && !input.value.trim()) {
                    throw new Error('T·∫•t c·∫£ link t√†i li·ªáu g·ªëc kh√¥ng ƒë∆∞·ª£c ph√©p ƒë·ªÉ tr·ªëng!');
                }
            });
            
            const finalLinks = Array.from(linksInputs)
                                   .map(input => input.value.trim())
                                   .filter(link => link); 

            const meetingRef = window.firebaseRef(window.firebaseDB, `meetings/${meetingId}`);
            
            await window.firebaseUpdate(meetingRef, { documentLinks: finalLinks });

            modalMessage.innerHTML = '‚úÖ C·∫≠p nh·∫≠t t√†i li·ªáu th√†nh c√¥ng!';
            modalMessage.style.display = 'block';
            modalMessage.style.backgroundColor = '#e8f5e9';
            modalMessage.style.color = '#2e7d32';
            modalMessage.style.borderLeftColor = '#4caf50';
            
            // Reload relevant data (list or calendar, depending on where the user is)
            if (document.getElementById('list').classList.contains('active')) {
                loadMeetings();
            }
            if (document.getElementById('calendar').classList.contains('active')) {
                loadCalendarMeetings();
            }
            
            setTimeout(() => {
                closeDocumentModal();
            }, 1500);

        } catch (error) {
            console.error('L·ªói l∆∞u t√†i li·ªáu:', error.message);
            modalMessage.innerHTML = `<strong>‚ö†Ô∏è L·ªói:</strong> ${error.message}`;
            modalMessage.style.display = 'block';
            modalMessage.style.backgroundColor = '#ffebee';
            modalMessage.style.color = '#d32f2f';
            modalMessage.style.borderLeftColor = '#d32f2f';
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ L∆∞u t√†i li·ªáu';
        }
    }
    window.saveDocuments = saveDocuments; 

    // START UTILITY FUNCTIONS FOR TIME
    function getRelativeTime(startStr, endStr) {
        const now = new Date().getTime();
        const start = new Date(startStr).getTime();
        const end = new Date(endStr).getTime();

        if (end < now) {
            // Meeting is over
            const diffPastMs = now - end;
            const totalSeconds = Math.floor(diffPastMs / 1000);
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            let result = '';
            if (days > 0) result += `${days} ng√†y `;
            if (hours > 0) result += `${hours} gi·ªù `;
            result += `${minutes} ph√∫t`;
            
            if (days === 0 && hours === 0 && minutes < 5) return `<span style="color: #D32F2F; font-weight: 700;">K·∫æT TH√öC V·ª™A XONG</span>`;
            return `<span style="color: #D32F2F; font-weight: 700;">K·∫æT TH√öC C√ÅCH ƒê√ÇY: ${result.trim()}</span>`;
            
        } else if (start <= now && end >= now) {
            // Meeting is ongoing
            const diffRemainingMs = end - now;
            const totalSeconds = Math.floor(diffRemainingMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            let result = '';
            if (hours > 0) result += `${hours} gi·ªù `;
            result += `${minutes} ph√∫t`;

            return `<span style="color: #FF9800; font-weight: 700;">ƒêANG DI·ªÑN RA - C√íN: ${result.trim()}</span>`;
        } else {
            // Meeting is upcoming
            const diffMs = start - now;
            const totalSeconds = Math.floor(diffMs / 1000);
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            let result = '';
            if (days > 0) result += `${days} ng√†y `;
            if (hours > 0) result += `${hours} gi·ªù `;
            result += `${minutes} ph√∫t`;

            if (days === 0 && hours === 0 && minutes < 30) return `<span style="color: #4CAF50; font-weight: 700; background: #e8f5e9; padding: 2px 6px; border-radius: 4px;">B·∫ÆT ƒê·∫¶U TRONG V√ÄI PH√öT!</span>`;
            return `<span style="color: #4CAF50; font-weight: 700;">B·∫ÆT ƒê·∫¶U TRONG: ${result.trim()}</span>`;
        }
    }
    window.getRelativeTime = getRelativeTime;
    // END UTILITY FUNCTIONS FOR TIME


    // START CALENDAR FUNCTIONS
    function formatDateToKey(date) {
      return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
    }

    function renderDaysOfWeek() {
        const container = document.getElementById('calendarDaysOfWeek');
        if (!container) return;
        container.innerHTML = DAYS_OF_WEEK.map(day => `<div>${day}</div>`).join('');
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentYear, currentMonth, allMeetings);
    }
    window.changeMonth = changeMonth; 

    function showDailyMeetings(dateKey) {
        const titleElement = document.getElementById('selectedDateTitle');
        const contentElement = document.getElementById('meetingsForDayContent');
        const currentEmail = sessionStorage.getItem('email'); // L·∫•y email hi·ªán t·∫°i
        
        const [year, month, day] = dateKey.split('-');
        titleElement.textContent = `(${day}/${month}/${year})`;

        const meetingsForDay = allMeetings[dateKey] || [];

        if (meetingsForDay.length === 0) {
            contentElement.innerHTML = `<p id="noMeetingsFound">Kh√¥ng c√≥ cu·ªôc h·ªçp n√†o v√†o ng√†y n√†y.</p>`;
            return;
        }

        contentElement.innerHTML = meetingsForDay.map(m => {
            const roleTag = m.chairperson === currentEmail ? 'üé§ Ch·ªß t·ªça' : 
                            m.secretary === currentEmail ? 'üìù Th∆∞ k√Ω' : 
                            m.createdBy === currentEmail ? '‚ú® Ng∆∞·ªùi t·∫°o' : 'üë§ Th√†nh vi√™n';
                            
            const allMembers = [];
            if (m.chairperson) allMembers.push(`üé§ Ch·ªß t·ªça: ${m.chairperson}`);
            if (m.secretary) allMembers.push(`üìù Th∆∞ k√Ω: ${m.secretary}`);
            if (m.members && m.members.length > 0) {
                m.members.forEach(member => allMembers.push(`üë§ Th√†nh vi√™n: ${member}`));
            }
            
            const membersHtml = allMembers.length > 0
                ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <p style="margin-bottom: 5px; font-weight: 600;">üë• Danh s√°ch tham gia (${allMembers.length}):</p>
                    ${allMembers.map(member => `<p style="font-size: 13px; margin: 2px 0; color: #444;">${member}</p>`).join('')}
                  </div>`
                : '';

            const relativeTimeHtml = getRelativeTime(m.startDatetime, m.endDatetime); 
            
            const existingLinks = m.documentLinks || [];
            const documentsHtml = existingLinks.length > 0 
                ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <p style="margin-bottom: 5px; font-weight: 600;">üìÑ T√†i li·ªáu ƒë√≠nh k√®m:</p>
                    ${existingLinks.map(link => 
                        `<p style="font-size: 13px; margin: 2px 0;">
                            <a href="${link}" target="_blank" style="color: #667eea; word-break: break-all;">${link}</a>
                        </p>`).join('')}
                  </div>`
                : `<p style="font-size: 13px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; font-weight: 600;">üìÑ T√†i li·ªáu ƒë√≠nh k√®m: <span style="font-weight: 400; color: #999;">Ch∆∞a c√≥</span></p>`;


            return `
                <div class="meeting-summary-item">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <h4 style="margin: 0; font-size: 16px;">üóìÔ∏è ${m.title || 'Kh√¥ng c√≥ t√™n'}</h4>
                        <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap;">Vai tr√≤: ${roleTag}</span>
                    </div>
                    <p>‚è∞ ${formatTime(m.startDatetime)} - ${formatTime(m.endDatetime)}</p>
                    <p style="margin-bottom: 8px;">${relativeTimeHtml}</p>
                    <p>üìç ƒê·ªãa ƒëi·ªÉm: ${m.meetingLink}</p>
                    ${membersHtml}
                    ${documentsHtml} 
                </div>
            `;
        }).join('');
    }
    window.showDailyMeetings = showDailyMeetings; 

    function renderCalendar(year, month, meetingsByDate) {
        const grid = document.getElementById('calendarGrid');
        const monthYearTitle = document.getElementById('currentMonthYear');
        if (!grid || !monthYearTitle) return;
        
        grid.innerHTML = ''; 
        
        const date = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const lastDayPrevMonth = new Date(year, month, 0);

        // Convert Sunday (0) start to Monday (0) start: 0(Mon)...6(Sun)
        const firstDayOfWeek = (date.getDay() === 0 ? 6 : date.getDay() - 1); 
        const daysInMonth = lastDay.getDate();
        const daysInPrevMonth = lastDayPrevMonth.getDate();
        const todayKey = formatDateToKey(new Date());

        monthYearTitle.textContent = `Th√°ng ${month + 1}, ${year}`;

        // 1. Fill leading days from previous month
        for (let i = firstDayOfWeek; i > 0; i--) {
            const prevDate = new Date(year, month - 1, daysInPrevMonth - i + 1);
            const dayKey = formatDateToKey(prevDate);
            grid.innerHTML += `
                <div class="calendar-day inactive-month" data-date="${dayKey}">
                    <span class="day-number">${prevDate.getDate()}</span>
                </div>
            `;
        }

        // 2. Fill current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const dayKey = formatDateToKey(currentDate);
            const hasMeeting = meetingsByDate[dayKey] && meetingsByDate[dayKey].length > 0;
            const isToday = dayKey === todayKey;

            let classList = '';
            if (hasMeeting) classList += ' has-meeting';
            if (isToday) classList += ' current-day';

            grid.innerHTML += `
                <div 
                    class="calendar-day${classList}" 
                    data-date="${dayKey}"
                    onclick="showDailyMeetings('${dayKey}')"
                >
                    <span class="day-number">${day}</span>
                    ${hasMeeting ? '<div class="meeting-indicator"></div>' : ''}
                </div>
            `;
        }
        
        // 3. Fill trailing days from next month
        let totalCells = firstDayOfWeek + daysInMonth;
        let trailingDays = 42 - totalCells; 
        if (totalCells <= 35) trailingDays = 35 - totalCells; 
        if (totalCells > 35 && totalCells <= 42) trailingDays = 42 - totalCells;
        
        for (let i = 1; i <= trailingDays; i++) {
            const nextDate = new Date(year, month + 1, i);
            const dayKey = formatDateToKey(nextDate);
            grid.innerHTML += `
                <div class="calendar-day inactive-month" data-date="${dayKey}">
                    <span class="day-number">${i}</span>
                </div>
            `;
        }
        
        const monthKey = year + '-' + String(month + 1).padStart(2, '0');
        const initialDateKey = todayKey.startsWith(monthKey) 
                             ? todayKey 
                             : (new Date(year, month, 1) < new Date() 
                                ? monthKey + '-01' 
                                : todayKey);
        
        showDailyMeetings(initialDateKey);
    }
    
    function loadCalendarMeetings() {
        renderDaysOfWeek();
        const currentEmail = sessionStorage.getItem('email');
        
        const filterRoomSelect = document.getElementById('calendarFilterRoom');
        if (!filterRoomSelect) return; 

        // 1. Populate Room Filter options if empty
        if (filterRoomSelect.options.length === 1) { 
            const roomOptions = MEETING_ROOMS.map(room => `<option value="${room}">${room}</option>`).join('');
            filterRoomSelect.insertAdjacentHTML('beforeend', roomOptions);
        }
        // 2. Get the current room filter value
        const filterRoom = filterRoomSelect.value;
        
        const meetingsByDate = {};
        const data = rawAllMeetings; // Use in-memory data

        if (data) {
            Object.keys(data).forEach(key => {
                const meeting = { id: key, ...data[key] };
                
                // Filter by Room: true if filterRoom is empty OR meetingLink matches filterRoom
                const matchesRoom = !filterRoom || meeting.meetingLink === filterRoom;
                
                const isChairperson = meeting.chairperson === currentEmail;
                const isSecretary = meeting.secretary === currentEmail;
                const isParticipant = meeting.members && meeting.members.includes(currentEmail);
                const isCreator = meeting.createdBy === currentEmail;

                // Only consider meetings the user is involved in AND room matches filter
                if ((isChairperson || isSecretary || isParticipant || isCreator) && matchesRoom) { 
                    const date = new Date(meeting.startDatetime);
                    const dateKey = formatDateToKey(date);
                    
                    // Only show future/ongoing meetings on the calendar
                    if (new Date(meeting.endDatetime) > new Date()) { 
                        if (!meetingsByDate[dateKey]) {
                            meetingsByDate[dateKey] = [];
                        }
                        meetingsByDate[dateKey].push(meeting);
                    }
                }
            });
        }
        
        allMeetings = meetingsByDate; 
        renderCalendar(currentYear, currentMonth, allMeetings);
    }
    // END CALENDAR FUNCTIONS

    function loadMeetings() {
      const container = document.getElementById('meetingsContainer');
      const filterDateInput = document.getElementById('filterDate');
      const filterRoomSelect = document.getElementById('filterRoom');
      if (!container || !filterDateInput || !filterRoomSelect) return;

      // 1. Populate Room Filter options if empty
      if (filterRoomSelect.options.length === 1) { // Only '-- T·∫•t c·∫£ ph√≤ng --' exists
          const roomOptions = MEETING_ROOMS.map(room => `<option value="${room}">${room}</option>`).join('');
          filterRoomSelect.insertAdjacentHTML('beforeend', roomOptions);
      }

      // 2. Get Filter values
      const filterDate = filterDateInput.value;
      const filterRoom = filterRoomSelect.value;
      const currentEmail = sessionStorage.getItem('email');
      
      container.innerHTML = '<p style="text-align: center; padding: 20px; grid-column: 1/-1; color: #666;">ƒêang t·∫£i...</p>';

      let filteredMeetings = [];
      const data = rawAllMeetings; // Use in-memory data

      if (!data || Object.keys(data).length === 0) {
        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Ch∆∞a c√≥ cu·ªôc h·ªçp n√†o</p>';
        return;
      }

      Object.keys(data).forEach(key => {
        const meeting = { id: key, ...data[key] };
        
        const isChairperson = meeting.chairperson === currentEmail;
        const isSecretary = meeting.secretary === currentEmail;
        const isParticipant = meeting.members && meeting.members.includes(currentEmail);
        const isCreator = meeting.createdBy === currentEmail;

        // Only consider meetings the user is involved in
        if (isChairperson || isSecretary || isParticipant || isCreator) {
          
          // Filter by Room
          const matchesRoom = !filterRoom || meeting.meetingLink === filterRoom;
          
          // Filter by Date
          const meetingStartDate = meeting.startDatetime ? meeting.startDatetime.substring(0, 10) : '';
          const matchesDate = !filterDate || meetingStartDate === filterDate;
          
          if (matchesRoom && matchesDate) {
             filteredMeetings.push(meeting);
          }
        }
      });

      // 3. Sort by start date/time (earliest first)
      filteredMeetings.sort((a, b) => new Date(a.startDatetime) - new Date(b.startDatetime));

      if (filteredMeetings.length === 0) {
        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">Kh√¥ng t√¨m th·∫•y cu·ªôc h·ªçp n√†o theo ƒëi·ªÅu ki·ªán l·ªçc.</p>';
        return;
      }
      
      // 4. Display the filtered meetings
      container.innerHTML = filteredMeetings.map(meeting => {
        const roleTag = meeting.chairperson === currentEmail ? 'üé§ Ch·ªß t·ªça' : 
                       meeting.secretary === currentEmail ? 'üìù Th∆∞ k√Ω' : 
                       meeting.createdBy === currentEmail ? '‚ú® Ng∆∞·ªùi t·∫°o' : 'üë§ Th√†nh vi√™n';
        
        const allMembers = [];
        if (meeting.chairperson) allMembers.push(`üé§ Ch·ªß t·ªça: ${meeting.chairperson}`);
        if (meeting.secretary) allMembers.push(`üìù Th∆∞ k√Ω: ${meeting.secretary}`);
        if (meeting.members && meeting.members.length > 0) {
          meeting.members.forEach(m => allMembers.push(`üë§ Th√†nh vi√™n: ${m}`));
        }
        
        const relativeTimeHtml = getRelativeTime(meeting.startDatetime, meeting.endDatetime); // ADDED
        
        const isSecretary = meeting.secretary === currentEmail;
        const canEditDocuments = isSecretary; 

        const existingLinks = meeting.documentLinks || [];
        const safeTitle = meeting.title ? meeting.title.replace(/'/g, "\\'") : 'N/A';
        const linksForEdit = existingLinks.map(link => link.replace(/'/g, "\\'"));
        
        const documentsHtml = existingLinks.length > 0 
          ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
              <p style="margin-bottom: 6px; font-weight: 600;">üìÑ T√†i li·ªáu ƒë√≠nh k√®m:</p>
              ${existingLinks.map(link => 
                  `<p style="font-size: 13px; margin: 2px 0;">
                      <a href="${link}" target="_blank" style="color: #667eea; word-break: break-all;">${link}</a>
                  </p>`
              ).join('')}
            </div>`
          : `<p style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0; font-weight: 600;">üìÑ T√†i li·ªáu ƒë√≠nh k√®m: <span style="font-weight: 400; color: #999;">Ch∆∞a c√≥</span></p>`;

        let editButtonText;
        let editButtonColor;
        if (canEditDocuments) {
            if (existingLinks.length === 0) {
                editButtonText = '‚ûï Th√™m T√†i li·ªáu';
                editButtonColor = '#4caf50';
            } else {
                editButtonText = '‚úèÔ∏è S·ª≠a T√†i li·ªáu';
                editButtonColor = '#ff9800';
            }
        }
        
        const viewEditButtons = `
          <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
              <button 
                  style="background: #00bcd4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;"
                  onmouseover="this.style.background='#0097a7'" onmouseout="this.style.background='#00bcd4'"
                  onclick="viewDocuments('${meeting.id}', '${safeTitle}', [${linksForEdit.map(l => `'${l}'`).join(', ')}])"
              >
                  üëÅÔ∏è Xem T√†i li·ªáu (${existingLinks.length})
              </button>
              ${canEditDocuments ? 
                  `<button 
                      style="background: ${editButtonColor}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;"
                      onmouseover="this.style.background='${editButtonColor === '#4caf50' ? '#388e3c' : '#f57c00'}'" onmouseout="this.style.background='${editButtonColor}'"
                      onclick="showEditDocumentModal('${meeting.id}', '${safeTitle}', [${linksForEdit.map(l => `'${l}'`).join(', ')}], true)"
                  >
                      ${editButtonText}
                  </button>`
                  : ''
              }
          </div>
        `;
        
        const membersHtml = allMembers.length > 0
          ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
              <p style="margin-bottom: 6px; font-weight: 600;">üë• Danh s√°ch tham gia (${allMembers.length}):</p>
              ${allMembers.map(m => `<p style="font-size: 13px; margin: 2px 0; color: #444;">${m}</p>`).join('')}
            </div>`
          : '';
          
        return `
          <div class="meeting-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; gap: 8px;">
              <h3 style="margin: 0; flex: 1;">üóìÔ∏è ${meeting.title || 'Kh√¥ng c√≥ t√™n'}</h3>
              <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap;">${roleTag}</span>
            </div>
            <p><strong>üé§ Ch·ªß t·ªça:</strong> ${meeting.chairperson || 'N/A'}</p>
            <p><strong>üìù Th∆∞ k√Ω:</strong> ${meeting.secretary || 'N/A'}</p>
            <p class="time" style="margin: 8px 0;"><strong>‚è∞ Th·ªùi gian:</strong><br>${formatDate(meeting.startDatetime)}<br>${formatTime(meeting.startDatetime)} - ${formatTime(meeting.endDatetime)}</p>
            <p style="margin-bottom: 8px;">${relativeTimeHtml}</p>
            <p><strong>üìç ƒê·ªãa ƒëi·ªÉm:</strong><br>${meeting.meetingLink || 'N/A'}</p>
            <p><strong>‚ú® Ng∆∞·ªùi t·∫°o:</strong> ${meeting.createdBy || 'N/A'}</p>
            ${membersHtml}
            ${documentsHtml}
            ${viewEditButtons}
            <p style="font-size: 11px; color: #999; margin-top: 12px; padding-top: 8px; border-top: 1px solid #f0f0f0;">üìÖ ƒê∆∞·ª£c t·∫°o: ${new Date(meeting.createdAt).toLocaleString('vi-VN')}</p>
          </div>
        `;
      }).join('');
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('vi-VN', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }
    
    function updateParticipantDropdown() {
      const select = document.getElementById('participantSelect');
      const chairperson = document.getElementById('chairperson').value;
      const secretary = document.getElementById('secretary').value;
      const creator = sessionStorage.getItem('email');
      
      const excludedEmails = [chairperson, secretary, creator].filter(e => e);
      
      select.innerHTML = '<option value="">-- Ch·ªçn th√†nh vi√™n --</option>';
      
      allSystemEmails.forEach(email => {
        if (!excludedEmails.includes(email) && !selectedParticipants.includes(email)) {
          const option = document.createElement('option');
          option.value = email;
          option.textContent = email;
          select.appendChild(option);
        }
      });
    }

    function addParticipant() {
      const select = document.getElementById('participantSelect');
      const email = select.value;
      if (!email) { alert('Vui l√≤ng ch·ªçn th√†nh vi√™n!'); return; }
      
      selectedParticipants.push(email);
      updateParticipantsList();
      updateParticipantDropdown();
    }
    window.addParticipant = addParticipant;

    function removeParticipant(email) {
      selectedParticipants = selectedParticipants.filter(e => e !== email);
      updateParticipantsList();
      updateParticipantDropdown();
    }
    window.removeParticipant = removeParticipant;

    function updateParticipantsList() {
      const listDiv = document.getElementById('participantsList');
      if (selectedParticipants.length === 0) {
        listDiv.innerHTML = '<span class="empty-state">Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒë∆∞·ª£c th√™m</span>';
        return;
      }
      listDiv.innerHTML = selectedParticipants.map(email => `
        <div class="participant-tag">
          <span>${email}</span>
          <button type="button" onclick="removeParticipant('${email}')">√ó</button>
        </div>
      `).join('');
    }
    
    /**
     * Checks if the new meeting time overlaps with any existing meetings in the same room.
     * @param {string} newStartTimeStr - New meeting start time (ISO string).
     * @param {string} newEndTimeStr - New meeting end time (ISO string).
     * @param {string} newRoom - The room being booked.
     * @returns {string|null} - The title of the conflicting meeting, or null if no conflict.
     */
    function checkConflict(newStartTimeStr, newEndTimeStr, newRoom) {
        const newStart = new Date(newStartTimeStr).getTime();
        const newEnd = new Date(newEndTimeStr).getTime();
        
        const allMeetingsData = rawAllMeetings; 

        for (const key in allMeetingsData) {
            const existingMeeting = allMeetingsData[key];
            
            // 1. Check for Room match
            if (existingMeeting.meetingLink === newRoom) {
                const existingStart = new Date(existingMeeting.startDatetime).getTime();
                const existingEnd = new Date(existingMeeting.endDatetime).getTime();
                
                // 2. Check for Time overlap
                // The new meeting overlaps if:
                // (NewStart < ExistingEnd) AND (NewEnd > ExistingStart)
                if (newStart < existingEnd && newEnd > existingStart) {
                    return existingMeeting.title || 'Cu·ªôc h·ªçp kh√¥ng c√≥ t√™n'; 
                }
            }
        }
        
        return null; // No conflict found
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      const errorMsg = document.getElementById('errorMessage');
      const successMsg = document.getElementById('successMessage');

      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ ƒêang l∆∞u...';

      try {
        const startTimeStr = document.getElementById('startTime').value;
        const endTimeStr = document.getElementById('endTime').value;
        const chairperson = document.getElementById('chairperson').value;
        const secretary = document.getElementById('secretary').value;
        const location = document.getElementById('location').value;

        if (new Date(startTimeStr) >= new Date(endTimeStr)) {
          throw new Error('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu!');
        }

        if (chairperson === secretary) {
          throw new Error('Ch·ªß t·ªça v√† th∆∞ k√Ω kh√¥ng th·ªÉ l√† c√πng m·ªôt ng∆∞·ªùi!');
        }
        
        if (!location) {
             throw new Error('Vui l√≤ng ch·ªçn ƒê·ªãa ƒëi·ªÉm h·ªçp!');
        }
        
        // --- NEW CONFLICT CHECK LOGIC ---
        const conflictingMeetingTitle = checkConflict(startTimeStr, endTimeStr, location);
        
        if (conflictingMeetingTitle) {
            throw new Error(`Ph√≤ng h·ªçp **${location}** ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t cho cu·ªôc h·ªçp: **${conflictingMeetingTitle}**. Vui l√≤ng ch·ªçn ph√≤ng ho·∫∑c th·ªùi gian kh√°c.`);
        }
        // --- END CONFLICT CHECK LOGIC ---
        
        const documentLinksInputs = document.querySelectorAll('#documentLinksContainer .document-link-input');
        const documentLinks = Array.from(documentLinksInputs).map(input => input.value.trim()).filter(link => link);
        
        const meetingData = {
          title: document.getElementById('meetingName').value,
          startDatetime: startTimeStr,
          endDatetime: endTimeStr,
          chairperson: chairperson,
          secretary: secretary,
          members: selectedParticipants,
          meetingLink: location, 
          documentLinks: documentLinks,
          createdBy: sessionStorage.getItem('email'),
          createdAt: new Date().toISOString(),
          startTimestamp: new Date(startTimeStr).getTime(),
          endTimestamp: new Date(endTimeStr).getTime(),
          host: sessionStorage.getItem('email'),
          isNotified: false
        };

        const meetingsRef = window.firebaseRef(window.firebaseDB, 'meetings');
        const newMeetingRef = window.firebasePush(meetingsRef);
        await window.firebaseSet(newMeetingRef, meetingData);

        console.log('‚úÖ L∆∞u cu·ªôc h·ªçp th√†nh c√¥ng!', meetingData);
        errorMsg.classList.remove('show');
        successMsg.classList.add('show');
        
        setTimeout(() => { successMsg.classList.remove('show'); }, 3000);

        // Reset form
        document.getElementById('meetingForm').reset();
        document.getElementById('documentLinksContainer').innerHTML = '';
        addDocumentLinkInput();
        selectedParticipants = [];
        updateParticipantsList();

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0, 16);
        const endTime = new Date(now.getTime() + 60 * 60 * 1000);
        document.getElementById('endTime').value = endTime.toISOString().slice(0, 16);
        updateParticipantDropdown(); 

      } catch (error) {
        console.error('L·ªói:', error.message);
        errorMsg.innerHTML = `<strong>‚ö†Ô∏è L·ªói:</strong> ${error.message}`;
        errorMsg.classList.add('show');
        successMsg.classList.remove('show'); // Hide success if error occurs
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '‚ú® T·∫°o cu·ªôc h·ªçp';
      }
    }
    window.handleSubmit = handleSubmit;

    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
    window.logout = logout;

    window.onload = checkAuth;
  </script>
</body>
</html>