<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ƒêƒÉng nh·∫≠p b·∫±ng Google</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .card { 
      background: #fff; 
      padding: 70px 55px;
      border-radius: 22px; 
      box-shadow: 0 18px 55px rgba(0,0,0,0.28); 
      width: 100%;
      max-width: 560px; 
      text-align: center; 
      transform: scale(1.15);
    }
    .logo {
      width: 90px;
      height: 90px;
      margin: 0 auto 20px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    h1 { 
      font-size: 24px; 
      margin: 0 0 8px;
      color: #1a1a1a;
      font-weight: 600;
    }
    .subtitle {
      color: #666; 
      margin-bottom: 28px;
      font-size: 14px;
      line-height: 1.5;
    }
    #g_button { 
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }
    .error { 
      color: #d32f2f; 
      background: #ffebee; 
      padding: 14px; 
      border-radius: 8px; 
      margin-top: 16px; 
      font-size: 14px;
      line-height: 1.4;
      border-left: 4px solid #d32f2f;
      text-align: left;
      display: none;
    }
    .error.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .footer {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      font-size: 12px;
      color: #999;
    }
    .loading {
      display: none;
      margin-top: 16px;
      color: #667eea;
      font-size: 14px;
    }
    .loading.show {
      display: block;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCsbZeCIr7mMabfVIlNBWQuoAFBQYxEIu4",
      authDomain: "iot1-8812b.firebaseapp.com",
      databaseURL: "https://iot1-8812b-default-rtdb.firebaseio.com",
      projectId: "iot1-8812b",
      storageBucket: "iot1-8812b.firebasestorage.app",
      messagingSenderId: "325115994620",
      appId: "1:325115994620:web:c8d99d4d4b4646228d1279"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebaseOnValue = onValue;
  </script>
</head>
<body>
  <div class="card">
    <div class="logo">
      <img src="img/Screenshot 2025-12-06 004751.png" alt="Logo">
    </div>

    <h1>ƒêƒÉng nh·∫≠p</h1>
    <p class="subtitle">S·ª≠ d·ª•ng t√†i kho·∫£n Google ƒë·ªÉ ti·∫øp t·ª•c</p>

    <div id="g_button"></div>
    
    <div id="loadingMsg" class="loading">ƒêang x·ª≠ l√Ω...</div>
    <div id="errorMsg" class="error"></div>

    <div class="footer">
      Ch·ªâ ƒëƒÉng nh·∫≠p th√†nh c√¥ng<br>n·∫øu c√≥ t√†i kho·∫£n <strong>trong h·ªá th·ªëng</strong>
    </div>
  </div>

  <script>
    const CLIENT_ID = "342595955640-k6qg5h3q60n04jr9t1h546ob28q9s094.apps.googleusercontent.com";
    const ADMIN_EMAIL = "ucute2262@gmail.com"; 

    let ALLOWED_EMAILS = [];
    let isFirebaseLoaded = false;
    let authAttempted = false;

    function showError(message) {
      const errorDiv = document.getElementById('errorMsg');
      errorDiv.innerHTML = '<strong>‚ùå L·ªói:</strong> ' + message;
      errorDiv.classList.add('show');
      
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 6000);
    }

    function showLoading(show) {
      const loadingDiv = document.getElementById('loadingMsg');
      if (show) {
        loadingDiv.classList.add('show');
      } else {
        loadingDiv.classList.remove('show');
      }
    }

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
          atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join('')
        );
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error("Parse JWT error:", e);
        return null;
      }
    }

    function handleCredentialResponse(response) {
      if (authAttempted) return;
      authAttempted = true;

      console.log("‚úÖ Nh·∫≠n ƒë∆∞·ª£c credential t·ª´ Google");
      showLoading(true);

      const payload = parseJwt(response.credential);
      
      if (!payload) {
        showLoading(false);
        authAttempted = false;
        showError("Kh√¥ng th·ªÉ x√°c th·ª±c th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.");
        return;
      }

      const userEmail = payload.email;
      const userName = payload.name;
      
      console.log("üë§ User:", userName);
      console.log("üìß Email:", userEmail);
      
      if (!isFirebaseLoaded) {
          showLoading(false);
          authAttempted = false;
          showError("ƒêang t·∫£i c·∫•u h√¨nh h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau v√†i gi√¢y.");
          return;
      }

      if (!ALLOWED_EMAILS.includes(userEmail)) {
        showLoading(false);
        authAttempted = false;
        showError(
          `Email "<strong>${userEmail}</strong>" kh√¥ng c√≥ quy·ªÅn truy c·∫≠p h·ªá th·ªëng.<br><br>` +
          `Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ ƒë∆∞·ª£c c·∫•p quy·ªÅn.`
        );
        console.warn("üö´ Unauthorized email:", userEmail);
        return;
      }

      const is_admin = userEmail === ADMIN_EMAIL;
      
      const userData = {
        id_token: response.credential,
        name: userName,
        email: userEmail,
        picture: payload.picture || "",
        is_admin: is_admin,
        loginTime: new Date().toISOString()
      };

      Object.keys(userData).forEach(key => {
        sessionStorage.setItem(key, userData[key]);
      });

      console.log("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Admin:", is_admin);
      console.log("üìÑ Chuy·ªÉn h∆∞·ªõng ƒë·∫øn home.html...");

      setTimeout(() => {
        window.location.href = "home.html";
      }, 500);
    }
    
    function loadAllowedEmails() {
      if (typeof window.firebaseDB === 'undefined') {
          console.error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
          return;
      }
      
      const allowedRef = window.firebaseRef(window.firebaseDB, 'allowed_emails');
      
      window.firebaseOnValue(allowedRef, (snapshot) => {
        const data = snapshot.val();
        ALLOWED_EMAILS = data ? Object.values(data) : [];
        
        if (!ALLOWED_EMAILS.includes(ADMIN_EMAIL)) {
            ALLOWED_EMAILS.push(ADMIN_EMAIL);
        }
        
        isFirebaseLoaded = true;
        console.log(`‚úÖ ƒê√£ t·∫£i ${ALLOWED_EMAILS.length} email ƒë∆∞·ª£c ph√©p t·ª´ Firebase.`);
      }, (error) => {
          console.error("L·ªói t·∫£i danh s√°ch email t·ª´ Firebase:", error);
          showError("L·ªói k·∫øt n·ªëi CSDL! Vui l√≤ng ki·ªÉm tra console log.");
          isFirebaseLoaded = true;
      });
    }

    window.onload = function () {
      console.log("üöÄ ƒêang kh·ªüi t·∫°o Google Sign-In...");
      
      loadAllowedEmails();
      
      if (!CLIENT_ID || CLIENT_ID.includes("YOUR_")) {
        showError("Vui l√≤ng c·∫•u h√¨nh CLIENT_ID trong file index.html");
        document.getElementById('g_button').innerHTML = 
          '<div style="color:#d32f2f;padding:10px;border:1px solid #d32f2f;border-radius:6px;">‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh CLIENT_ID</div>';
        return;
      }

      try {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleCredentialResponse,
          auto_select: false,
          cancel_on_tap_outside: true
        });

        google.accounts.id.renderButton(
          document.getElementById("g_button"),
          { 
            theme: "outline", 
            size: "large", 
            width: 280,
            text: "signin_with",
            shape: "rectangular",
            logo_alignment: "left"
          }
        );

        console.log("‚úÖ Google Sign-In ƒë√£ s·∫µn s√†ng!");
        
      } catch (error) {
        console.error("‚ùå L·ªói kh·ªüi t·∫°o Google Sign-In:", error);
        showError("Kh√¥ng th·ªÉ t·∫£i Google Sign-In. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.");
      }
    };

    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('GSI_LOGGER')) {
        console.error("‚ùå Origin kh√¥ng ƒë∆∞·ª£c ph√©p:", window.location.origin);
        showError(
          `<strong>Origin kh√¥ng ƒë∆∞·ª£c ph√©p!</strong><br><br>` +
          `Vui l√≤ng th√™m <code>${window.location.origin}</code> v√†o<br>` +
          `<strong>Authorized JavaScript origins</strong> trong Google Cloud Console.`
        );
      }
    }, true);
  </script>
</body>
</html>